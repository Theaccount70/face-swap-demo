<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Real-Time Live Face Swap</title>
<script defer src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"></script>
<style>
  body { margin: 0; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; }
  video, canvas { position: absolute; }
  #uploadContainer { position: relative; z-index: 10; margin-top: 20px; color: white; }
</style>
</head>
<body>

<video id="video" autoplay muted playsinline width="320" height="240"></video>
<canvas id="overlay" width="320" height="240"></canvas>

<div id="uploadContainer">
  <input type="file" id="upload" accept="image/*">
</div>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('overlay');
const ctx = canvas.getContext('2d');
let swapFace = null;

// Upload face image
document.getElementById('upload').addEventListener('change', (event) => {
  const file = event.target.files[0];
  if (file) {
    const img = new Image();
    img.onload = () => { swapFace = img; };
    img.src = URL.createObjectURL(file);
  }
});

async function start() {
  // Load face detection + landmark models
  await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/');
  await faceapi.nets.faceLandmark68TinyNet.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/');

  // Use iPhone camera
  const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
  video.srcObject = stream;

  video.addEventListener('play', () => {
    const drawLoop = async () => {
      const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
                                      .withFaceLandmarks(true);

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      if (swapFace) {
        detections.forEach(det => {
          const landmarks = det.landmarks;
          const nose = landmarks.getNose()[0];
          const jaw = landmarks.getJawOutline();
          const left = jaw[0];
          const right = jaw[16];

          const width = right.x - left.x;
          const height = width * (swapFace.height / swapFace.width);
          const x = left.x;
          const y = nose.y - height / 2;

          ctx.drawImage(swapFace, x, y, width, height);
        });
      }

      requestAnimationFrame(drawLoop);
    };
    drawLoop();
  });
}

start();
</script>
</body>
</html>