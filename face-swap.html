<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Face Swap Demo iPhone</title>
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js/dist/face-api.min.js"></script>
  <style>
    body { margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; background: #000; }
    canvas { position: absolute; }
    video { position: absolute; transform: scaleX(-1); } /* mirror camera */
  </style>
</head>
<body>

<video id="video" width="320" height="240" autoplay muted playsinline></video>
<canvas id="overlay" width="320" height="240"></canvas>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('overlay');
const ctx = canvas.getContext('2d');

// Face image to overlay (PNG with transparent background)
const faceImg = new Image();
faceImg.crossOrigin = "anonymous";
faceImg.src = 'https://i.imgur.com/3Z9R6Qd.png'; // replace with your PNG face image

async function start() {
  // Load face-api.js models from CDN
  await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js/weights/');
  await faceapi.nets.faceLandmark68TinyNet.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js/weights/');

  // Access iPhone camera
  const stream = await navigator.mediaDevices.getUserMedia({ video: true });
  video.srcObject = stream;

  video.onplay = () => {
    const update = async () => {
      const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
                                      .withFaceLandmarks(true);

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      detections.forEach(det => {
        const landmarks = det.landmarks;
        const jaw = landmarks.getJawOutline();
        const leftEye = landmarks.getLeftEye();
        const rightEye = landmarks.getRightEye();

        // Bounding box for overlay
        const minX = Math.min(...jaw.map(p => p.x));
        const maxX = Math.max(...jaw.map(p => p.x));
        const minY = Math.min(...leftEye.map(p => p.y), ...rightEye.map(p => p.y));
        const maxY = Math.max(...jaw.map(p => p.y));

        const width = maxX - minX;
        const height = maxY - minY;

        // Head rotation based on eyes
        const eyeDx = rightEye[3].x - leftEye[0].x;
        const eyeDy = rightEye[3].y - leftEye[0].y;
        const angle = Math.atan2(eyeDy, eyeDx);

        // Circular mask for smooth edges
        const maskCanvas = document.createElement('canvas');
        maskCanvas.width = width;
        maskCanvas.height = height;
        const maskCtx = maskCanvas.getContext('2d');

        maskCtx.beginPath();
        maskCtx.arc(width / 2, height / 2, Math.max(width, height)/2, 0, 2 * Math.PI);
        maskCtx.closePath();
        maskCtx.clip();
        maskCtx.drawImage(faceImg, 0, 0, width, height);

        // Draw rotated overlay
        ctx.save();
        ctx.translate(minX + width/2, minY + height/2);
        ctx.rotate(angle);
        ctx.globalAlpha = 0.9; // blending
        ctx.drawImage(maskCanvas, -width/2, -height/2);
        ctx.restore();
        ctx.globalAlpha = 1.0;
      });

      requestAnimationFrame(update);
    };
    update();
  };
}

start();
</script>

</body>
</html>